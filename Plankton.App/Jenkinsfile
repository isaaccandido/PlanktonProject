pipeline {
    agent any

    environment {
        NAME = 'plankton'
        DOCKERFILE_PATH = './Plankton.App/Dockerfile'
    }

    stages {
        stage('Build Podman Image') {
            steps {
                echo "üõ†Ô∏è Building image ${NAME} ‚Ä¶"
                sh """
                    sudo podman build \
                        --pull \
                        --no-cache \
                        -t ${NAME} \
                        -f ${DOCKERFILE_PATH} .
                """
            }
        }

        stage('Deploy Podman Container') {
            steps {
                echo "üöÄ Deploying container ${NAME} ‚Ä¶"
                sh """
                    if sudo podman ps -a --format '{{.Names}}' | grep -q \"^${NAME}\$\"; then
                        echo 'üßπ Removing existing container‚Ä¶'
                        sudo podman rm -f ${NAME}
                    fi

                    sudo podman run \
                        --network=host \
                        --restart always \
                        --name ${NAME} \
                        -d \
                        ${NAME}
                """
            }
        }

        stage('Verify Runtime') {
            steps {
                echo "üîç Checking .NET runtimes in the running container‚Ä¶"
                sh """
                    sudo podman exec ${NAME} dotnet --list-runtimes || true
                    sudo podman exec ${NAME} dotnet --info || true
                """
            }
        }
    }

    post {
        always {
            cleanWs()
        }
        success {
            echo '‚úÖ Pipeline completed successfully!'
        }
        failure {
            echo '‚ùå Pipeline failed!'
        }
    }
}
